name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # =============================================================================
  # Lint & Type Check
  # =============================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npm run typecheck

      - name: Check formatting
        run: npx prettier --check "**/*.{ts,tsx,json,md}"

  # =============================================================================
  # Unit Tests
  # =============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --coverage --coverageReporters=lcov --coverageReporters=text-summary

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            junit.xml

  # =============================================================================
  # Component Tests
  # =============================================================================
  component-tests:
    name: Component Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run component tests
        run: npm test -- --testPathPattern=components --coverage=false

  # =============================================================================
  # Hook Tests
  # =============================================================================
  hook-tests:
    name: Hook Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run hook tests
        run: npm test -- --testPathPattern=hooks --coverage=false

  # =============================================================================
  # Integration Tests
  # =============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, component-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm test -- --testPathPattern=integration --coverage=false

  # =============================================================================
  # Coverage Report
  # =============================================================================
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: coverage

      - name: Check coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Line coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "Coverage below 70% threshold!"
            exit 1
          fi

  # =============================================================================
  # E2E Tests (Maestro) - Only on main branch
  # =============================================================================
  e2e-tests:
    name: E2E Tests (Maestro)
    runs-on: macos-latest
    needs: [lint, unit-tests]
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'run-e2e')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Maestro
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Start Metro bundler
        run: |
          npm start &
          sleep 30

      - name: Build iOS app for simulator
        run: |
          npx expo prebuild -p ios
          cd ios && xcodebuild -workspace TheRealTOC.xcworkspace -scheme TheRealTOC -destination 'platform=iOS Simulator,name=iPhone 15' -derivedDataPath build

      - name: Run Maestro smoke tests
        env:
          MAESTRO_TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          MAESTRO_TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: |
          maestro test .maestro/flows/smoke-test-suite.yaml --format junit

      - name: Upload Maestro results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maestro-results
          path: maestro-report/

  # =============================================================================
  # Test Summary
  # =============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, component-tests, hook-tests, integration-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Summary
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: '**/junit.xml'
          reporter: jest-junit

      - name: Slack Notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: |
            Test Results:
            - Lint: ${{ needs.lint.result }}
            - Unit Tests: ${{ needs.unit-tests.result }}
            - Component Tests: ${{ needs.component-tests.result }}
            - Hook Tests: ${{ needs.hook-tests.result }}
            - Integration Tests: ${{ needs.integration-tests.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
